<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Quest (AI Guide)</title>
    <!-- RPG Pixel Font -->
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        /* --- RPG Style Definitions (Dragon Quest Vibe) --- */
        :root {
            --primary-color: #fff;
            /* White text specifically */
            --bg-color: #000000;
            /* Black background */
            --card-bg: #000000;
            /* Black card background */
            --text-main: #ffffff;
            /* White text */
            --text-sub: #cccccc;
            /* Light gray subtext */
            --border-style: 2px solid #ffffff;
            /* Classic white border */
            --radius-md: 4px;
            /* Small radius for pixel feel, not too round */
            --radius-lg: 8px;
            --highlight-color: #f7e600;
            /* Yellow for highlights */
            --detail-btn-bg: #000080;
            /* Navy Blue */
            --simple-btn-bg: #006400;
            /* Dark Green */
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'DotGothic16', sans-serif;
            /* PIXEL FONT */
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: var(--bg-color);
            color: var(--text-main);
            -webkit-font-smoothing: none;
            /* Sharper pixels */
        }

        /* RPG Message Window Style Mixin */
        .rpg-window {
            background-color: #000;
            border: var(--border-style);
            border-radius: var(--radius-md);
            box-shadow: 0 0 0 1px #000;
            /* Inner outline contrast if needed */
            padding: 10px;
        }

        /* Helper: Blinking cursor for text */
        .cursor-blink {
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }

        /* „Éò„ÉÉ„ÉÄ„Éº */
        #brand-header {
            background: #000;
            padding: 16px;
            z-index: 10;
            border-bottom: var(--border-style);
        }

        .brand-title {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
            /* DotGothic is naturally bold-ish */
            color: var(--text-main);
            text-shadow: 2px 2px 0 #444;
            letter-spacing: 1px;
        }

        .brand-subtitle {
            margin: 4px 0 0 0;
            font-size: 0.9rem;
            color: var(--highlight-color);
        }

        /* Info Bar (User Stats) */
        #user-info-bar {
            display: flex;
            justify-content: space-between;
            padding: 8px 16px;
            border-bottom: var(--border-style);
            font-size: 0.9rem;
            background: #222;
        }

        /* Map Container */
        #map-container {
            flex: 1;
            position: relative;
            z-index: 5;
            margin: 8px;
            border: var(--border-style);
            /* White frame around map */
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        /* Map Controls Overrides */
        #current-location-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            background-color: #000;
            border: 2px solid #fff;
            border-radius: 4px;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 50;
        }

        .search-wrapper {
            position: relative;
            padding: 10px;
            background: #000;
        }

        #pac-input {
            width: 95%;
            /* Adjust for padding */
            background: #000;
            color: #fff;
            border: var(--border-style);
            padding: 8px;
            font-family: sans-serif;
            font-size: 16px;
        }

        /* Controls / List Area */
        #controls {
            flex: 1;
            background: var(--bg-color);
            overflow-y: auto;
            padding: 16px;
            z-index: 6;
            border-top: var(--border-style);
        }

        #status-header {
            font-size: 1.1rem;
            margin-bottom: 12px;
            color: var(--highlight-color);
            display: flex;
            align-items: center;
            border-bottom: 1px dashed #fff;
            padding-bottom: 4px;
        }

        /* Card Style Overhaul */
        .spot-card {
            display: flex;
            background: #000;
            border: var(--border-style);
            border-radius: var(--radius-md);
            padding: 8px;
            margin-bottom: 16px;
            position: relative;
            font-family: sans-serif;
            /* Revert to standard font for readability */
        }

        /* "Cursor" selection indicator for active card */
        .spot-card.playing::before {
            content: '‚ñ∂';
            position: absolute;
            left: -12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--highlight-color);
            animation: blink 1s step-end infinite;
        }

        .spot-card.playing {
            border-color: var(--highlight-color);
            background: #111;
        }

        .spot-img-box {
            width: 80px;
            height: 80px;
            flex-shrink: 0;
            border: 1px solid #fff;
            border-radius: 2px;
            overflow: hidden;
            margin-right: 12px;
            background: #333;
        }

        .spot-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            image-rendering: pixelated;
            /* Try to make images fit the vibe */
        }

        .spot-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .spot-title {
            font-size: 1.1rem;
            margin-bottom: 4px;
            line-height: 1.2;
            color: #fff;
        }

        .spot-rating {
            font-size: 0.9rem;
            color: var(--highlight-color);
            margin-bottom: 4px;
        }

        .spot-summary {
            font-size: 0.85rem;
            color: #ddd;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .btn-group {
            display: flex;
            gap: 8px;
        }

        .mode-btn {
            flex: 1;
            padding: 6px 0;
            border-radius: 2px;
            font-size: 0.9rem;
            border: 1px solid #fff;
            cursor: pointer;
            font-family: 'DotGothic16', sans-serif;
            color: #fff;
            text-align: center;
        }

        .btn-simple {
            background-color: var(--simple-btn-bg);
        }

        .btn-detail {
            background-color: var(--detail-btn-bg);
        }

        .mode-btn:active {
            transform: translateY(2px);
        }

        /* Player Bar - RPG Message Window Style */
        #audio-player-bar {
            position: fixed;
            bottom: -250px;
            left: 10px;
            right: 10px;
            background: #000;
            border: var(--border-style);
            border-radius: var(--radius-md);
            color: white;
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: bottom 0.3s;
            z-index: 100;
        }

        #audio-player-bar.visible {
            bottom: 10px;
        }

        .player-title {
            text-align: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #555;
            width: 100%;
            padding-bottom: 5px;
            color: var(--highlight-color);
        }

        .player-controls button {
            background: #000;
            border: 1px solid #fff;
            color: #fff;
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
            border-radius: 4px;
            margin: 0 5px;
        }

        /* Modal Overlay (New Game / Adventure Log) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .modal-window {
            background: #000;
            border: var(--border-style);
            border-radius: var(--radius-md);
            padding: 24px;
            width: 85%;
            max-width: 400px;
            text-align: center;
        }

        .modal-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--highlight-color);
            text-decoration: underline;
        }

        .rpg-input {
            width: 80%;
            background: #000;
            border: 1px solid #fff;
            color: white;
            padding: 10px;
            font-family: inherit;
            font-size: 1.2rem;
            margin-bottom: 20px;
            text-align: center;
        }

        .rpg-btn {
            background: #000;
            border: 2px solid #fff;
            color: #fff;
            padding: 10px 30px;
            font-size: 1.1rem;
            font-family: inherit;
            cursor: pointer;
            transition: background 0.2s;
        }

        .rpg-btn:hover {
            background: #333;
        }

        .char-select-container {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .char-option {
            width: 60px;
            height: 60px;
            cursor: pointer;
            border: 2px solid transparent;
            padding: 2px;
            background: #222;
        }

        .char-option img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            image-rendering: pixelated;
        }

        .char-option.selected {
            border-color: var(--highlight-color);
            background: #222;
        }

        .hidden {
            display: none !important;
        }

        /* --- Party HUD (Top Left Overlay) --- */
        #party-hud {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 100;
            cursor: pointer;
            filter: drop-shadow(2px 2px 0px rgba(0, 0, 0, 0.5));
            transition: transform 0.1s;
        }

        #party-hud:active {
            transform: scale(0.95);
        }

        .hud-char-box {
            width: 80px;
            height: 80px;
            /* No frame or background */
            position: relative;
        }

        /* Main Avatar (Background) */
        #hud-avatar {
            width: 100%;
            height: 100%;
            object-fit: contain;
            /* Show full character */
            image-rendering: pixelated;
            filter: drop-shadow(2px 2px 0 black);
            /* Contour */
        }

        /* Companion (Mini Icon Overlay) */
        #hud-companion {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 40%;
            height: 40%;
            object-fit: contain;
            image-rendering: pixelated;
            filter: drop-shadow(1px 1px 0 black);
            /* Pop out */
            z-index: 2;
        }

        /* --- Status Modal (Popup) --- */
        .status-content {
            background: #000;
            border: var(--border-style);
            border-radius: var(--radius-md);
            padding: 20px;
            width: 80%;
            max-width: 300px;
            text-align: center;
            color: white;
            position: relative;
        }

        .status-chars {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            height: 80px;
            /* Fixed height for animation space */
            align-items: flex-end;
            /* Align bottom */
        }

        .status-char-img {
            width: 64px;
            height: 64px;
            image-rendering: pixelated;
        }

        /* Walking Animation */
        @keyframes walk-bounce {
            0% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-8px);
            }

            100% {
                transform: translateY(0);
            }
        }

        .walking {
            animation: walk-bounce 0.6s infinite;
        }

        /* Delay second char slightly for natural feel */
        .walking:nth-child(2) {
            animation-delay: 0.3s;
        }
    </style>
</head>

<body>
    <!-- Adventure Log (Registration) Modal -->
    <div id="adventure-log-modal" class="modal-overlay">
        <div class="modal-window">
            <div class="modal-title">ÂÜíÈô∫„ÅÆÊõ∏„Çí„Å§„Åè„Çã</div>
            <p style="margin-bottom: 10px;">„ÅÇ„Å™„Åü„ÅÆÂêçÂâç„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ</p>
            <input type="text" id="input-player-name" class="rpg-input" placeholder="ÂãáËÄÖ„É®„Ç∑„Éí„Ç≥" maxlength="10">

            <p style="margin-bottom: 10px;">Âßø„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ</p>
            <div class="char-select-container" id="avatar-select">
                <div class="char-option selected" data-char="1"><img src="/static/avatar_1.png" alt="1"></div>
                <div class="char-option" data-char="2"><img src="/static/avatar_2.png" alt="2"></div>
                <div class="char-option" data-char="3"><img src="/static/avatar_3.png" alt="3"></div>
                <div class="char-option" data-char="4"><img src="/static/avatar_4.png" alt="4"></div>
                <div class="char-option" data-char="5"><img src="/static/avatar_5.png" alt="5"></div>
            </div>

            <p style="margin-bottom: 10px;">Áõ∏Ê£í„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ</p>
            <div class="char-select-container" id="companion-select">
                <div class="char-option selected" data-comp="dog"><img src="/static/comp_dog.png" alt="Dog"></div>
                <div class="char-option" data-comp="bird"><img src="/static/comp_bird.png" alt="Bird"></div>
                <div class="char-option" data-comp="monkey"><img src="/static/comp_monkey.png" alt="Monkey"></div>
                <div class="char-option" data-comp="bear"><img src="/static/comp_bear.png" alt="Bear"></div>
                <div class="char-option" data-comp="horse"><img src="/static/comp_horse.png" alt="Horse"></div>
            </div>

            <button class="rpg-btn" onclick="saveAdventureLog()">ÂÜíÈô∫„ÇíÂßã„ÇÅ„Çã</button>
        </div>
    </div>

    <!-- Main Layout -->
    <div id="brand-header">
        <div style="position: relative; text-align: center;">
            <h1 class="brand-title">TRAVEL QUEST</h1>
            <p class="brand-subtitle">AI Companion Guide</p>
            <button id="settings-btn" onclick="toggleSettings(true)"
                style="position:absolute; top:50%; right:0; transform:translateY(-50%); background:black; color:white; border:2px solid white; padding:5px 10px; font-family:'DotGothic16',sans-serif; cursor:pointer;">Ë®≠ÂÆö</button>
        </div>
    </div>

    <div id="user-info-bar" style="display:none;"></div> <!-- Legacy hidden -->

    <!-- Party HUD -->
    <div id="party-hud" onclick="openStatusModal()">
        <div class="hud-char-box">
            <img id="hud-avatar" src="" alt="Hero">
            <img id="hud-companion" src="" alt="Comp">
        </div>
    </div>

    <!-- Status Popup Modal -->
    <div id="status-modal" class="modal-overlay hidden">
        <div class="status-content" onclick="event.stopPropagation()">
            <h2 style="margin-top:0; border-bottom:1px dashed white; padding-bottom:5px;">„Çπ„ÉÜ„Éº„Çø„Çπ</h2>

            <div class="status-chars">
                <img id="status-avatar-img" class="status-char-img walking" src="">
                <img id="status-companion-img" class="status-char-img walking" src="">
            </div>

            <div style="text-align:left; padding:0 10px;">
                <p>ÂêçÂâçÔºö <span id="status-name" style="color:var(--highlight-color); font-size:1.2rem;"></span></p>
                <p>ËÅ∑Ê•≠Ôºö ÂãáËÄÖ</p>
                <p>Lv.Ôºö <span style="color:var(--highlight-color);">1</span></p>
                <p style="font-size:0.8rem; color:#aaa;">Ê¨°„ÅÆ„É¨„Éô„É´„Åæ„ÅßÔºö 999 exp</p>
            </div>

            <button class="rpg-btn" style="margin-top:20px; width:100%;" onclick="closeStatusModal()">Èñâ„Åò„Çã</button>
        </div>
    </div>

    <div id="map-container">
        <div class="search-wrapper">
            <input id="pac-input" type="text" placeholder="Â†¥ÊâÄ„Çí„Åï„Åå„Åô (Search)">
            <button id="clear-search-btn" onclick="clearSearch()" style="background:#333;">‚úï</button>
        </div>
        <div id="map"></div>
        <button id="current-location-btn" onclick="backToCurrentLocation()">
            <span>‚óé</span>
        </button>
    </div>

    <div id="controls">
        <div id="status-header"><span>‚öîÔ∏è</span>
            <div id="status-text">Âë®Ëæ∫„ÅÆ„Çπ„Éù„ÉÉ„Éà</div>
        </div>
        <div id="spot-list"></div>
    </div>

    <div id="loading"
        style="display: none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center; flex-direction:column; color:white;">
        <div class="loading-spinner" style="font-size:3rem;">‚åõ</div>
        <div class="loading-text" style="font-size:1.5rem; margin-top:20px;">È≠îÊ≥ï„ÇíË©†Âî±‰∏≠...</div>
    </div>

    <div id="script-overlay" class="rpg-window"
        style="display:none; position:fixed; bottom:0; width:95%; height:40vh; z-index:150; margin:10px; box-sizing:border-box;">
        <div style="display:flex; justify-content:space-between; border-bottom:1px solid #fff; padding-bottom:5px;">
            <span>üìú Scroll</span>
            <button onclick="toggleScript(false)" style="background:none; border:none; color:white;">‚úï</button>
        </div>
        <div id="script-body"
            style="height:90%; overflow-y:auto; padding-top:10px; color:#ddd; font-size:1.1rem; line-height:1.6;"></div>
    </div>

    <div id="audio-player-bar">
        <div class="player-title" id="player-title">-</div>
        <div class="player-controls" style="display:flex; justify-content:center; width:100%; margin-bottom:10px;">
            <button class="script-toggle-btn" onclick="toggleScript(true)"
                style="width:auto; padding:0 10px; font-size:0.8rem;">üìú</button>
            <button onclick="togglePlay()" id="play-pause-btn">‚è∏</button>
            <button onclick="stopAudio()" class="stop-btn" style="color:#ff5555; border-color:#ff5555;">‚ñ†</button>
        </div>
        <div class="player-progress-container" style="width:100%; display:flex; gap:10px; color:#aaa;">
            <span id="current-time">0:00</span>
            <input type="range" id="progress-bar" value="0" max="100" style="flex:1;">
            <span id="total-duration">0:00</span>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal"
        style="display: none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center;">
        <div class="settings-content"
            style="background:#000; border:2px solid #fff; padding:20px; border-radius:4px; width:90%; max-width:400px; color:white;">
            <div class="settings-header" style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3 id="settings-title">Ë®≠ÂÆö</h3>
                <button class="close-settings" onclick="toggleSettings(false)"
                    style="background:none; border:1px solid white; color:white; width:30px; height:30px; border-radius:50%;">‚úï</button>
            </div>
            <div class="setting-item">
                <label id="label-speed">‚è© ÂÜçÁîüÈÄüÂ∫¶</label>
                <div class="speed-options" style="display:flex; gap:5px; margin-top:10px;">
                    <button class="speed-btn" onclick="setSpeed(0.75)"
                        style="flex:1; background:black; color:white; border:1px solid white;">0.75x</button>
                    <button class="speed-btn active" onclick="setSpeed(1.0)"
                        style="flex:1; background:white; color:black; border:1px solid white;">1.0x</button>
                    <button class="speed-btn" onclick="setSpeed(1.25)"
                        style="flex:1; background:black; color:white; border:1px solid white;">1.25x</button>
                    <button class="speed-btn" onclick="setSpeed(1.5)"
                        style="flex:1; background:black; color:white; border:1px solid white;">1.5x</button>
                </div>
            </div>

            <hr style="border-top:1px dashed #555; margin:20px 0;">

            <div class="setting-item">
                <label>üìù ÂÜíÈô∫„ÅÆÊõ∏</label>
                <button onclick="editProfile()" class="rpg-btn"
                    style="width:100%; margin-top:10px; font-size:1rem;">Êõ∏„ÅçÁõ¥„Åô</button>
            </div>
        </div>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&callback=initApp&libraries=places"
        async defer></script>
    <script>
        // --- Adventure Log (User Data) ---
        let playerData = {
            name: "Adventurer",
            avatar: "1",
            companion: "dog"
        };

        function checkAdventureLog() {
            const saved = localStorage.getItem('travel_quest_data');
            if (saved) {
                playerData = JSON.parse(saved);
                document.getElementById('adventure-log-modal').classList.add('hidden');
                updatePlayerUI();
            } else {
                document.getElementById('adventure-log-modal').classList.remove('hidden');
            }
        }

        function saveAdventureLog() {
            const nameInput = document.getElementById('input-player-name').value;
            if (!nameInput) {
                alert("ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ");
                return;
            }

            const avatarEl = document.querySelector('#avatar-select .selected');
            const compEl = document.querySelector('#companion-select .selected');

            playerData.name = nameInput;
            playerData.avatar = avatarEl ? avatarEl.dataset.char : "1";
            playerData.companion = compEl ? compEl.dataset.comp : "dog";

            localStorage.setItem('travel_quest_data', JSON.stringify(playerData));

            document.getElementById('adventure-log-modal').classList.add('hidden');
            updatePlayerUI();
        }

        function updatePlayerUI() {
            // Update HUD
            const avatarSrc = `/static/avatar_${playerData.avatar}.png`;
            const compSrc = `/static/comp_${playerData.companion}.png`;

            document.getElementById('hud-avatar').src = avatarSrc;
            document.getElementById('hud-companion').src = compSrc;

            // Pre-fill status modal (optional, or do it on open)
        }

        function openStatusModal() {
            document.getElementById('status-name').innerText = playerData.name;
            document.getElementById('status-avatar-img').src = `/static/avatar_${playerData.avatar}.png`;
            document.getElementById('status-companion-img').src = `/static/comp_${playerData.companion}.png`;

            document.getElementById('status-modal').classList.remove('hidden');
        }

        function closeStatusModal() {
            document.getElementById('status-modal').classList.add('hidden');
        }

        function editProfile() {
            // Close settings
            toggleSettings(false);

            // Populate modal with current data
            document.getElementById('input-player-name').value = playerData.name;

            // Set Avatar
            document.querySelectorAll('#avatar-select .char-option').forEach(el => {
                if (el.dataset.char === playerData.avatar) el.classList.add('selected');
                else el.classList.remove('selected');
            });

            // Set Companion
            document.querySelectorAll('#companion-select .char-option').forEach(el => {
                if (el.dataset.comp === playerData.companion) el.classList.add('selected');
                else el.classList.remove('selected');
            });

            // Show Modal and change title
            const modal = document.getElementById('adventure-log-modal');
            modal.querySelector('.modal-title').innerText = "ÂÜíÈô∫„ÅÆÊõ∏„ÇíÊõ∏„ÅçÁõ¥„Åô";
            modal.querySelector('.rpg-btn').innerText = "Êõ¥Êñ∞„Åô„Çã";
            modal.classList.remove('hidden');
        }

        document.querySelectorAll('.char-option').forEach(el => {
            el.addEventListener('click', function () {
                this.parentElement.querySelectorAll('.char-option').forEach(sib => sib.classList.remove('selected'));
                this.classList.add('selected');
            });
        });

        // --- Core App Logic ---
        let map, currentMarker, placesService;
        let currentLang = 'ja';
        let audioObj = null;
        let currentLat, currentLng;
        let currentSpeed = 1.0;
        let currentVoice = 'female';
        let guideCache = {};

        const SERVER_URL = "/generate_guide";
        const PLACEHOLDER_IMG = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='3' width='18' height='18' rx='2' ry='2'/%3E%3Cpolyline points='21 15 16 10 5 21'/%3E%3C/svg%3E`;
        let sentenceTimings = [];

        function initApp() {
            checkAdventureLog();
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (p) => { initMap(p.coords.latitude, p.coords.longitude); },
                    (e) => { initMap(35.681236, 139.767125); },
                    { enableHighAccuracy: true }
                );
            } else { initMap(35.681236, 139.767125); }
        }

        function initMap(lat, lng) {
            currentLat = lat; currentLng = lng;
            const center = { lat: lat, lng: lng };
            map = new google.maps.Map(document.getElementById("map"), {
                center: center, zoom: 15, disableDefaultUI: true, clickableIcons: false
            });
            currentMarker = new google.maps.Marker({ position: center, map: map });
            placesService = new google.maps.places.PlacesService(map);
            fetchSpots(lat, lng);

            map.addListener("click", (e) => updateMapLocation(e.latLng.lat(), e.latLng.lng()));

            const input = document.getElementById("pac-input");
            const autocomplete = new google.maps.places.Autocomplete(input);
            autocomplete.bindTo("bounds", map);
            autocomplete.addListener("place_changed", () => {
                const place = autocomplete.getPlace();
                if (!place.geometry) return;
                updateMapLocation(place.geometry.location.lat(), place.geometry.location.lng());
            });
        }

        function updateMapLocation(lat, lng) {
            currentLat = lat; currentLng = lng;
            const newPos = { lat: lat, lng: lng };
            currentMarker.setPosition(newPos);
            map.panTo(newPos);
            fetchSpots(lat, lng);
        }

        function backToCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (p) => { updateMapLocation(p.coords.latitude, p.coords.longitude); }
                );
            }
        }

        function clearSearch() {
            document.getElementById("pac-input").value = "";
        }

        function getCacheKey(title, mode, lang, voice) { return `${title}_${mode}_${lang}_${voice}`; }

        async function fetchSpots(lat, lng) {
            const list = document.getElementById('spot-list');
            list.innerHTML = "<p>„Éû„ÉÉ„Éó„Çí„Çπ„Ç≠„É£„É≥‰∏≠...</p>";
            guideCache = {};

            const wikiLang = 'ja';
            const wikiUrl = `https://${wikiLang}.wikipedia.org/w/api.php?origin=*&action=query&format=json&generator=geosearch&ggscoord=${lat}|${lng}&ggsradius=1500&prop=extracts|pageimages&piprop=thumbnail&pithumbsize=200&exintro&explaintext&ggslimit=20`;

            try {
                const res = await fetch(wikiUrl);
                const data = await res.json();

                if (!data.query || !data.query.pages) {
                    list.innerHTML = "<p>„Åì„ÅÆ„Ç®„É™„Ç¢„Å´„ÇØ„Ç®„Çπ„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>"; return;
                }

                const wikiSpots = Object.values(data.query.pages);
                wikiSpots.sort((a, b) => b.extract.length - a.extract.length);

                prefetchGuides(wikiSpots.slice(0, 3));

                list.innerHTML = "";
                wikiSpots.forEach(place => {
                    let imgTag = `<img src="${place.thumbnail ? place.thumbnail.source : PLACEHOLDER_IMG}" class="spot-img">`;
                    const safeTitle = place.title.replace(/'/g, "\\'");
                    const safeExtract = encodeURIComponent(place.extract);
                    const simpleSummary = place.extract.substring(0, 60) + "...";

                    const card = document.createElement('div');
                    card.className = 'spot-card';
                    card.innerHTML = `
                        <div class="spot-img-box">${imgTag}</div>
                        <div class="spot-content">
                            <div class="spot-title">${place.title}</div>
                            <div class="spot-rating">QUEST ‚òÖ</div>
                            <div class="spot-summary">${simpleSummary}</div>
                            <div class="btn-group">
                                <button class="mode-btn btn-simple" onclick="playAiGuide('${safeTitle}', '${safeExtract}', this.closest('.spot-card'), 'simple')">
                                    <span>‚ö°</span> „Åã„Çì„Åü„Çì
                                </button>
                                <button class="mode-btn btn-detail" onclick="playAiGuide('${safeTitle}', '${safeExtract}', this.closest('.spot-card'), 'detail')">
                                    <span>‚òï</span> „Åò„Å£„Åè„Çä
                                </button>
                            </div>
                        </div>
                    `;
                    list.appendChild(card);
                });
            } catch (e) { console.error(e); list.innerHTML = "<p>ÈÄö‰ø°„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ</p>"; }
        }

        function prefetchGuides(spots) {
            let prefetchVoice = 'female';
            spots.forEach(spot => {
                const key = getCacheKey(spot.title, 'simple', currentLang, prefetchVoice);
                if (!guideCache[key]) {
                    guideCache[key] = fetchGuideData(spot.title, spot.extract, 'simple', currentLang, prefetchVoice, currentSpeed);
                }
            });
        }

        // --- UPDATED FETCH FUNCTION TO SEND COMPANION ---
        async function fetchGuideData(title, wikiText, mode, lang, voice, speed) {
            // Use global playerData for companion
            const companion = (typeof playerData !== 'undefined' && playerData.companion) ? playerData.companion : 'dog';

            const response = await fetch(SERVER_URL, {
                method: "POST", headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    title,
                    text: wikiText,
                    lang,
                    mode,
                    config: {
                        voice,
                        speed,
                        companion: companion
                    }
                })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || "Server Error");
            return data;
        }

        async function playAiGuide(title, encodedWikiText, element, mode) {
            const wikiText = decodeURIComponent(encodedWikiText);
            document.querySelectorAll('.spot-card').forEach(el => el.classList.remove('playing'));
            element.classList.add('playing');

            const loadingEl = document.getElementById('loading');
            loadingEl.style.display = 'flex';

            const cacheKey = getCacheKey(title, mode, currentLang, 'female');

            try {
                let data;
                if (guideCache[cacheKey]) {
                    data = await guideCache[cacheKey];
                } else {
                    const promise = fetchGuideData(title, wikiText, mode, currentLang, 'female', currentSpeed);
                    guideCache[cacheKey] = promise;
                    data = await promise;
                }

                if (audioObj) audioObj.pause();
                audioObj = new Audio(data.audio_uri);
                audioObj.playbackRate = currentSpeed;
                prepareScript(data.script);
                toggleScript(true);
                showPlayer(title);
                audioObj.play();

                audioObj.addEventListener('ended', () => {
                    document.getElementById('play-pause-btn').innerText = "‚ñ∂";
                    element.classList.remove('playing');
                });

            } catch (e) {
                alert("ÁîüÊàêÂ§±Êïó: " + e.message);
                delete guideCache[cacheKey];
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        function toggleScript(show) { document.getElementById('script-overlay').style.display = show ? 'block' : 'none'; }
        function showPlayer(title) {
            document.getElementById('audio-player-bar').classList.add('visible');
            document.getElementById('player-title').innerText = title;
            document.getElementById('play-pause-btn').innerText = "‚è∏";
        }
        function togglePlay() {
            if (!audioObj) return;
            if (audioObj.paused) { audioObj.play(); document.getElementById('play-pause-btn').innerText = "‚è∏"; }
            else { audioObj.pause(); document.getElementById('play-pause-btn').innerText = "‚ñ∂"; }
        }
        function stopAudio() {
            if (audioObj) { audioObj.pause(); audioObj.currentTime = 0; }
            document.getElementById('audio-player-bar').classList.remove('visible');
            document.getElementById('script-overlay').style.display = 'none';
        }
        function prepareScript(text) { document.getElementById('script-body').innerText = text; }

        function toggleSettings(show) { document.getElementById('settings-modal').style.display = show ? 'flex' : 'none'; }
        function setSpeed(speed) {
            currentSpeed = speed;
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseFloat(btn.innerText) === speed) {
                    btn.classList.add('active');
                    btn.style.background = 'white'; btn.style.color = 'black';
                } else {
                    btn.style.background = 'black'; btn.style.color = 'white';
                }
            });
            if (audioObj) audioObj.playbackRate = speed;
        }

    </script>
</body>

</html>